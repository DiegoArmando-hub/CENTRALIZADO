<script>
  // Utilidades globales
  const App = {
    showLoading: function(element) {
      if (element) {
        const originalText = element.innerHTML;
        element.setAttribute('data-original-text', originalText);
        element.innerHTML = '<div class="loading"></div>';
        element.disabled = true;
      }
    },
    
    hideLoading: function(element) {
      if (element) {
        const originalText = element.getAttribute('data-original-text');
        element.innerHTML = originalText;
        element.disabled = false;
      }
    },
    
    showAlert: function(message, type, container) {
      type = type || 'danger';
      container = container || document.body;
      
      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert alert-' + type;
      alertDiv.textContent = message;
      
      container.insertBefore(alertDiv, container.firstChild);
      
      setTimeout(function() {
        alertDiv.remove();
      }, 5000);
    },
    
    handleError: function(error) {
      console.error('App Error:', error);
      this.showAlert(error.message || 'Error del sistema');
    }
  };

  // Servicios de comunicaci√≥n con Google Apps Script
  function callServerFunction(functionName) {
    const args = Array.prototype.slice.call(arguments, 1);
    return new Promise(function(resolve, reject) {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        [functionName].apply(google.script.run, args);
    });
  }

  // ‚úÖ LOGIN - MANTENER EXACTAMENTE COMO ESTABA (QUE FUNCIONA)
  function handleLogin(event) {
    console.log('üîÑ Iniciando proceso de login...');
    event.preventDefault();
    
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const loginBtn = document.getElementById('loginBtn');
    
    if (!email || !password) {
      App.showAlert('Por favor complete todos los campos');
      return;
    }
    
    App.showLoading(loginBtn);
    
    // ‚úÖ MANTENER EXACTAMENTE IGUAL - QUE S√ç FUNCIONA
    callServerFunction('loginAndRedirect', email, password)
      .then(function(result) {
        console.log('üì® Respuesta del servidor:', result);
        
        if (result.success) {
          console.log('‚úÖ Login exitoso, redirigiendo a:', result.redirectUrl);
          // ‚úÖ MANTENER EXACTAMENTE IGUAL
          const redirectUrl = result.redirectUrl + '?auth=' + Date.now();
          console.log('üîó URL final:', redirectUrl);
          // window.location.replace(response.redirectUrl);
          window.location.replace(redirectUrl);
        } else {
          App.hideLoading(loginBtn);
          App.showAlert(result.message || 'Credenciales incorrectas');
        }
      })
      .catch(function(error) {
        console.error('‚ùå Error en login:', error);
        App.hideLoading(loginBtn);
        App.showAlert('Error del sistema: ' + error.message);
      });
  }

  // ‚úÖ LOGOUT - SOLO ESTA PARTE SE MODIFICA
  function handleLogout() {
    console.log('üîÑ Iniciando logout...');
    const logoutBtn = event.target;
    const originalText = logoutBtn.innerHTML;
    logoutBtn.innerHTML = 'Cerrando...';
    logoutBtn.disabled = true;
    
    // ‚úÖ SOLUCI√ìN SIMPLE PARA LOGOUT - REDIRECCI√ìN INMEDIATA
    callServerFunction('logout')
      .then(function(result) {
        console.log('üì® Respuesta logout:', result);
        if (result.success) {
          console.log('‚úÖ Logout exitoso, redirigiendo...');
          // ‚úÖ REDIRECCI√ìN INMEDIATA SIN COMPLICACIONES
          window.location.href = result.redirectUrl + '?logout=' + Date.now();
        } else {
          // ‚úÖ SI FALLA EL LOGOUT, REDIRIGIR DE TODAS FORMAS
          console.log('‚ö†Ô∏è Logout fall√≥, redirigiendo igual...');
          window.location.href = window.location.origin + window.location.pathname + '?logout=' + Date.now();
        }
      })
      .catch(function(error) {
        console.error('‚ùå Error en logout:', error);
        // ‚úÖ SI HAY ERROR, REDIRIGIR DE TODAS FORMAS
        console.log('üîÑ Forzando redirecci√≥n a pesar del error...');
        window.location.href = window.location.origin + window.location.pathname + '?logout=' + Date.now();
      })
      .finally(function() {
        // ‚úÖ POR SI ACASO, FORZAR REDIRECCI√ìN DESPU√âS DE 3 SEGUNDOS
        setTimeout(function() {
          if (!window.location.href.includes('logout')) {
            console.log('üîÑ Redirecci√≥n de seguridad despu√©s de timeout...');
            window.location.href = window.location.origin + window.location.pathname + '?logout=' + Date.now();
          }
        }, 3000);
      });
  }

  // ‚úÖ FUNCI√ìN PARA M√ìDULOS (sin cambios)
  function openModule(moduleName) {
    console.log('üîÑ Abriendo m√≥dulo:', moduleName);
    const btn = event.target.closest('.module-card') || event.target;
    App.showLoading(btn);
    
    callServerFunction('openModuleWithIP', moduleName, 'unknown')
      .then(function(result) {
        App.hideLoading(btn);
        if (result.success) {
          App.showAlert('Redirigiendo al m√≥dulo...', 'success');
          setTimeout(function() {
            window.location.href = result.redirectUrl;
          }, 1000);
        } else {
          App.showAlert(result.message || 'Error al abrir m√≥dulo');
        }
      })
      .catch(function(error) {
        App.hideLoading(btn);
        App.handleError(error);
      });
  }

  // User interface
  function updateUserInfo(userInfo) {
    const userInfoElement = document.getElementById('userInfo');
    if (userInfoElement && userInfo) {
      userInfoElement.innerHTML = 
        '<strong>Usuario:</strong> ' + userInfo.name + ' (' + userInfo.alias + ') | ' +
        '<strong>Email:</strong> ' + userInfo.email + ' | ' +
        '<strong>Hora login:</strong> ' + new Date(userInfo.loginTime).toLocaleString();
    }
  }

  // Inicializaci√≥n
  function initializeApp() {
    console.log('üöÄ Inicializando aplicaci√≥n...');
    
    // ‚úÖ LIMPIAR PAR√ÅMETROS DE URL SI EXISTEN
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('auth') || urlParams.has('logout')) {
      console.log('üßπ Limpiando par√°metros de URL...');
      window.history.replaceState({}, document.title, window.location.pathname);
    }
    
    // Verificar si estamos en login o dashboard
    const loginForm = document.getElementById('loginForm');
    const userInfo = document.getElementById('userInfo');
    
    if (userInfo) {
      // Estamos en el dashboard - cargar info del usuario
      console.log('üìä Cargando dashboard...');
      callServerFunction('getUserInfo')
        .then(function(userInfo) {
          console.log('üë§ Usuario cargado:', userInfo);
          updateUserInfo(userInfo);
        })
        .catch(function(error) {
          console.error('‚ùå Error cargando usuario:', error);
        });
    }
    
    if (loginForm) {
      // Estamos en el login - configurar formulario
      console.log('üîê Configurando formulario de login...');
      loginForm.addEventListener('submit', handleLogin);
    }
    
    console.log('‚úÖ Aplicaci√≥n inicializada correctamente');
  }

  // Inicializar cuando el DOM est√© listo
  document.addEventListener('DOMContentLoaded', initializeApp);
</script>